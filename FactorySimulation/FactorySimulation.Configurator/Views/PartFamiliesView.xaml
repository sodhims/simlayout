<UserControl x:Class="FactorySimulation.Configurator.Views.PartFamiliesView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:local="clr-namespace:FactorySimulation.Configurator"
             mc:Ignorable="d"
             d:DesignHeight="500" d:DesignWidth="900">

    <UserControl.Resources>
        <local:BoolToVisibilityConverter x:Key="BoolToVisibility"/>
        <local:InverseBoolToVisibilityConverter x:Key="InverseBoolToVisibility"/>
        <local:NullToVisibilityConverter x:Key="NullToVisibility"/>
        <local:NullToCollapsedConverter x:Key="NullToCollapsed"/>

        <!-- Style for inherited fields -->
        <Style x:Key="InheritedTextBoxStyle" TargetType="TextBox">
            <Setter Property="Background" Value="#F0F0F0"/>
            <Setter Property="FontStyle" Value="Italic"/>
            <Setter Property="Foreground" Value="#666666"/>
            <Setter Property="ToolTip" Value="From family defaults"/>
        </Style>

        <!-- Style for local fields -->
        <Style x:Key="LocalTextBoxStyle" TargetType="TextBox">
            <Setter Property="Background" Value="White"/>
            <Setter Property="FontStyle" Value="Normal"/>
            <Setter Property="Foreground" Value="Black"/>
        </Style>
    </UserControl.Resources>

    <Grid>
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="250"/>
            <ColumnDefinition Width="5"/>
            <ColumnDefinition Width="250"/>
            <ColumnDefinition Width="5"/>
            <ColumnDefinition Width="*"/>
        </Grid.ColumnDefinitions>

        <!-- Left Panel - Families -->
        <Grid Grid.Column="0">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="*"/>
            </Grid.RowDefinitions>

            <TextBlock Grid.Row="0" Text="Part Families" FontWeight="Bold" FontSize="14" Margin="5"/>

            <!-- Toolbar -->
            <StackPanel Grid.Row="1" Orientation="Horizontal" Margin="5">
                <TextBox Text="{Binding SearchText, UpdateSourceTrigger=PropertyChanged}"
                         Width="150" Margin="0,0,5,0"
                         ToolTip="Search families"/>
                <Button Content="+ Family" Command="{Binding AddFamilyCommand}" Padding="8,2"/>
            </StackPanel>

            <!-- Family List -->
            <ListBox Grid.Row="2"
                     ItemsSource="{Binding Families}"
                     SelectedItem="{Binding SelectedFamily}"
                     Margin="5">
                <ListBox.ItemTemplate>
                    <DataTemplate>
                        <StackPanel Margin="2">
                            <TextBlock FontWeight="SemiBold">
                                <Run Text="{Binding FamilyCode}"/>
                                <Run Text=" - "/>
                                <Run Text="{Binding Name}"/>
                            </TextBlock>
                            <TextBlock Text="{Binding CategoryName}"
                                       FontSize="10" Foreground="Gray"/>
                        </StackPanel>
                    </DataTemplate>
                </ListBox.ItemTemplate>
            </ListBox>
        </Grid>

        <GridSplitter Grid.Column="1" Width="5" HorizontalAlignment="Stretch"/>

        <!-- Middle Panel - Variants -->
        <Grid Grid.Column="2">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="*"/>
            </Grid.RowDefinitions>

            <StackPanel Grid.Row="0" Margin="5">
                <TextBlock Text="Variants" FontWeight="Bold" FontSize="14"/>
                <TextBlock FontSize="11" Foreground="Gray"
                           Visibility="{Binding SelectedFamily, Converter={StaticResource NullToCollapsed}}">
                    <Run Text="of "/>
                    <Run Text="{Binding SelectedFamily.FamilyCode, FallbackValue=''}"/>
                </TextBlock>
            </StackPanel>

            <!-- Toolbar -->
            <StackPanel Grid.Row="1" Orientation="Horizontal" Margin="5">
                <Button Content="+ Variant"
                        Command="{Binding AddVariantCommand}"
                        Padding="8,2"/>
                <Button Content="Delete"
                        Command="{Binding DeleteVariantCommand}"
                        Padding="8,2" Margin="5,0,0,0"/>
            </StackPanel>

            <!-- Variant List -->
            <ListBox Grid.Row="2"
                     ItemsSource="{Binding SelectedFamilyVariants}"
                     SelectedItem="{Binding SelectedVariant}"
                     Margin="5">
                <ListBox.ItemTemplate>
                    <DataTemplate>
                        <StackPanel Margin="2">
                            <TextBlock FontWeight="SemiBold" Text="{Binding PartNumber}"/>
                            <TextBlock Text="{Binding Name}" FontSize="11" Foreground="Gray"/>
                        </StackPanel>
                    </DataTemplate>
                </ListBox.ItemTemplate>
            </ListBox>

            <!-- Empty state when no family selected -->
            <TextBlock Grid.Row="2"
                       Text="Select a family to view variants"
                       HorizontalAlignment="Center"
                       VerticalAlignment="Center"
                       Foreground="Gray"
                       Visibility="{Binding SelectedFamily, Converter={StaticResource NullToVisibility}}"/>
        </Grid>

        <GridSplitter Grid.Column="3" Width="5" HorizontalAlignment="Stretch"/>

        <!-- Right Panel - Detail Editor -->
        <Grid Grid.Column="4" Margin="10">
            <!-- Family Detail (when family selected, no variant selected) -->
            <ScrollViewer VerticalScrollBarVisibility="Auto">
                <StackPanel Visibility="{Binding SelectedFamily, Converter={StaticResource NullToCollapsed}}">
                    <!-- Show Family details when no variant selected -->
                    <StackPanel Visibility="{Binding SelectedVariant, Converter={StaticResource NullToVisibility}}">
                        <TextBlock Text="Family Details" FontWeight="Bold" FontSize="16" Margin="0,0,0,10"/>

                        <TabControl>
                            <!-- General Tab -->
                            <TabItem Header="General">
                                <StackPanel Margin="10">
                                    <TextBlock Text="Family Code" FontWeight="SemiBold" Margin="0,5,0,2"/>
                                    <TextBox Text="{Binding SelectedFamily.FamilyCode, UpdateSourceTrigger=PropertyChanged}"
                                             IsReadOnly="True" Background="#F5F5F5"/>

                                    <TextBlock Text="Name" FontWeight="SemiBold" Margin="0,10,0,2"/>
                                    <TextBox Text="{Binding SelectedFamily.Name, UpdateSourceTrigger=PropertyChanged}"/>

                                    <TextBlock Text="Category" FontWeight="SemiBold" Margin="0,10,0,2"/>
                                    <TextBox Text="{Binding SelectedFamily.CategoryName}"
                                             IsReadOnly="True" Background="#F5F5F5"/>

                                    <TextBlock Text="Description" FontWeight="SemiBold" Margin="0,10,0,2"/>
                                    <TextBox Text="{Binding SelectedFamily.Description, UpdateSourceTrigger=PropertyChanged}"
                                             TextWrapping="Wrap" AcceptsReturn="True" Height="80"/>

                                    <CheckBox Content="Active" IsChecked="{Binding SelectedFamily.IsActive}" Margin="0,10,0,0"/>

                                    <Button Content="Delete Family"
                                            Command="{Binding DeleteFamilyCommand}"
                                            HorizontalAlignment="Left"
                                            Padding="15,5" Margin="0,20,0,0"
                                            Background="#FFE0E0"/>
                                </StackPanel>
                            </TabItem>

                            <!-- Default Properties Tab -->
                            <TabItem Header="Default Properties">
                                <StackPanel Margin="10">
                                    <TextBlock Text="These defaults apply to all variants unless overridden"
                                               FontStyle="Italic" Foreground="Gray" Margin="0,0,0,15"/>

                                    <TextBlock Text="Physical Dimensions" FontWeight="SemiBold" Margin="0,0,0,5"/>

                                    <Grid>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="80"/>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="30"/>
                                        </Grid.ColumnDefinitions>
                                        <Grid.RowDefinitions>
                                            <RowDefinition Height="Auto"/>
                                            <RowDefinition Height="Auto"/>
                                            <RowDefinition Height="Auto"/>
                                            <RowDefinition Height="Auto"/>
                                        </Grid.RowDefinitions>

                                        <TextBlock Grid.Row="0" Grid.Column="0" Text="Length (mm)" VerticalAlignment="Center" Margin="0,2"/>
                                        <TextBox Grid.Row="0" Grid.Column="1" Text="{Binding EditDefaultLengthMm, UpdateSourceTrigger=PropertyChanged}" Margin="0,2"/>

                                        <TextBlock Grid.Row="1" Grid.Column="0" Text="Width (mm)" VerticalAlignment="Center" Margin="0,2"/>
                                        <TextBox Grid.Row="1" Grid.Column="1" Text="{Binding EditDefaultWidthMm, UpdateSourceTrigger=PropertyChanged}" Margin="0,2"/>

                                        <TextBlock Grid.Row="2" Grid.Column="0" Text="Height (mm)" VerticalAlignment="Center" Margin="0,2"/>
                                        <TextBox Grid.Row="2" Grid.Column="1" Text="{Binding EditDefaultHeightMm, UpdateSourceTrigger=PropertyChanged}" Margin="0,2"/>

                                        <TextBlock Grid.Row="3" Grid.Column="0" Text="Weight (kg)" VerticalAlignment="Center" Margin="0,2"/>
                                        <TextBox Grid.Row="3" Grid.Column="1" Text="{Binding EditDefaultWeightKg, UpdateSourceTrigger=PropertyChanged}" Margin="0,2"/>
                                    </Grid>

                                    <TextBlock Text="Handling" FontWeight="SemiBold" Margin="0,15,0,5"/>

                                    <Grid>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="100"/>
                                            <ColumnDefinition Width="*"/>
                                        </Grid.ColumnDefinitions>
                                        <Grid.RowDefinitions>
                                            <RowDefinition Height="Auto"/>
                                            <RowDefinition Height="Auto"/>
                                            <RowDefinition Height="Auto"/>
                                            <RowDefinition Height="Auto"/>
                                        </Grid.RowDefinitions>

                                        <TextBlock Grid.Row="0" Grid.Column="0" Text="Container Type" VerticalAlignment="Center" Margin="0,2"/>
                                        <ComboBox Grid.Row="0" Grid.Column="1"
                                                  ItemsSource="{Binding ContainerTypes}"
                                                  SelectedItem="{Binding EditDefaultContainerType}" Margin="0,2"/>

                                        <TextBlock Grid.Row="1" Grid.Column="0" Text="Units/Container" VerticalAlignment="Center" Margin="0,2"/>
                                        <TextBox Grid.Row="1" Grid.Column="1" Text="{Binding EditDefaultUnitsPerContainer, UpdateSourceTrigger=PropertyChanged}" Margin="0,2"/>

                                        <CheckBox Grid.Row="2" Grid.Column="0" Grid.ColumnSpan="2"
                                                  Content="Requires Forklift"
                                                  IsChecked="{Binding EditDefaultRequiresForklift}" Margin="0,5"/>

                                        <TextBlock Grid.Row="3" Grid.Column="0" Text="Notes" VerticalAlignment="Top" Margin="0,2"/>
                                        <TextBox Grid.Row="3" Grid.Column="1"
                                                 Text="{Binding EditDefaultNotes, UpdateSourceTrigger=PropertyChanged}"
                                                 TextWrapping="Wrap" AcceptsReturn="True" Height="60" Margin="0,2"/>
                                    </Grid>

                                    <Button Content="Save Defaults"
                                            Command="{Binding SaveFamilyDefaultsCommand}"
                                            HorizontalAlignment="Left"
                                            Padding="15,5" Margin="0,15,0,0"/>
                                </StackPanel>
                            </TabItem>
                        </TabControl>
                    </StackPanel>

                    <!-- Show Variant details when variant selected -->
                    <StackPanel Visibility="{Binding SelectedVariant, Converter={StaticResource NullToCollapsed}}">
                        <TextBlock Text="Variant Details" FontWeight="Bold" FontSize="16" Margin="0,0,0,10"/>

                        <TabControl>
                            <!-- General Tab -->
                            <TabItem Header="General">
                                <StackPanel Margin="10">
                                    <TextBlock Text="Part Number" FontWeight="SemiBold" Margin="0,5,0,2"/>
                                    <TextBox Text="{Binding SelectedVariant.PartNumber, UpdateSourceTrigger=PropertyChanged}"
                                             IsReadOnly="True" Background="#F5F5F5"/>

                                    <TextBlock Text="Name" FontWeight="SemiBold" Margin="0,10,0,2"/>
                                    <TextBox Text="{Binding SelectedVariant.Name, UpdateSourceTrigger=PropertyChanged}"/>

                                    <TextBlock Text="Family" FontWeight="SemiBold" Margin="0,10,0,2"/>
                                    <TextBox Text="{Binding SelectedVariant.FamilyCode}"
                                             IsReadOnly="True" Background="#F5F5F5"/>

                                    <TextBlock Text="Category (inherited)" FontWeight="SemiBold" Margin="0,10,0,2"/>
                                    <TextBox Text="{Binding SelectedVariant.CategoryName}"
                                             IsReadOnly="True" Background="#F5F5F5"/>

                                    <TextBlock Text="Description" FontWeight="SemiBold" Margin="0,10,0,2"/>
                                    <TextBox Text="{Binding SelectedVariant.Description, UpdateSourceTrigger=PropertyChanged}"
                                             TextWrapping="Wrap" AcceptsReturn="True" Height="80"/>

                                    <CheckBox Content="Active" IsChecked="{Binding SelectedVariant.IsActive}" Margin="0,10,0,0"/>
                                </StackPanel>
                            </TabItem>

                            <!-- Physical Properties Tab -->
                            <TabItem Header="Physical">
                                <StackPanel Margin="10">
                                    <TextBlock Text="Gray italic values are inherited from family defaults"
                                               FontStyle="Italic" Foreground="Gray" Margin="0,0,0,15"/>

                                    <Grid>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="80"/>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="50"/>
                                        </Grid.ColumnDefinitions>
                                        <Grid.RowDefinitions>
                                            <RowDefinition Height="Auto"/>
                                            <RowDefinition Height="Auto"/>
                                            <RowDefinition Height="Auto"/>
                                            <RowDefinition Height="Auto"/>
                                        </Grid.RowDefinitions>

                                        <TextBlock Grid.Row="0" Grid.Column="0" Text="Length (mm)" VerticalAlignment="Center" Margin="0,2"/>
                                        <TextBox Grid.Row="0" Grid.Column="1"
                                                 Text="{Binding EditLengthMm, UpdateSourceTrigger=PropertyChanged}"
                                                 Margin="0,2"
                                                 Background="{Binding IsLengthInherited, Converter={StaticResource BoolToVisibility}, ConverterParameter=#F0F0F0}"
                                                 FontStyle="{Binding IsLengthInherited, Converter={StaticResource BoolToVisibility}, ConverterParameter=Italic}"/>
                                        <Button Grid.Row="0" Grid.Column="2" Content="Clear" Command="{Binding ClearLengthCommand}"
                                                Padding="2" Margin="2" FontSize="10"/>

                                        <TextBlock Grid.Row="1" Grid.Column="0" Text="Width (mm)" VerticalAlignment="Center" Margin="0,2"/>
                                        <TextBox Grid.Row="1" Grid.Column="1"
                                                 Text="{Binding EditWidthMm, UpdateSourceTrigger=PropertyChanged}" Margin="0,2"/>
                                        <Button Grid.Row="1" Grid.Column="2" Content="Clear" Command="{Binding ClearWidthCommand}"
                                                Padding="2" Margin="2" FontSize="10"/>

                                        <TextBlock Grid.Row="2" Grid.Column="0" Text="Height (mm)" VerticalAlignment="Center" Margin="0,2"/>
                                        <TextBox Grid.Row="2" Grid.Column="1"
                                                 Text="{Binding EditHeightMm, UpdateSourceTrigger=PropertyChanged}" Margin="0,2"/>
                                        <Button Grid.Row="2" Grid.Column="2" Content="Clear" Command="{Binding ClearHeightCommand}"
                                                Padding="2" Margin="2" FontSize="10"/>

                                        <TextBlock Grid.Row="3" Grid.Column="0" Text="Weight (kg)" VerticalAlignment="Center" Margin="0,2"/>
                                        <TextBox Grid.Row="3" Grid.Column="1"
                                                 Text="{Binding EditWeightKg, UpdateSourceTrigger=PropertyChanged}" Margin="0,2"/>
                                        <Button Grid.Row="3" Grid.Column="2" Content="Clear" Command="{Binding ClearWeightCommand}"
                                                Padding="2" Margin="2" FontSize="10"/>
                                    </Grid>

                                    <Button Content="Save Properties"
                                            Command="{Binding SavePropertiesCommand}"
                                            HorizontalAlignment="Left"
                                            Padding="15,5" Margin="0,15,0,0"/>
                                </StackPanel>
                            </TabItem>

                            <!-- Handling Tab -->
                            <TabItem Header="Handling">
                                <StackPanel Margin="10">
                                    <Grid>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="100"/>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="50"/>
                                        </Grid.ColumnDefinitions>
                                        <Grid.RowDefinitions>
                                            <RowDefinition Height="Auto"/>
                                            <RowDefinition Height="Auto"/>
                                            <RowDefinition Height="Auto"/>
                                            <RowDefinition Height="Auto"/>
                                        </Grid.RowDefinitions>

                                        <TextBlock Grid.Row="0" Grid.Column="0" Text="Container Type" VerticalAlignment="Center" Margin="0,2"/>
                                        <ComboBox Grid.Row="0" Grid.Column="1"
                                                  ItemsSource="{Binding ContainerTypes}"
                                                  SelectedItem="{Binding EditContainerType}" Margin="0,2"/>
                                        <Button Grid.Row="0" Grid.Column="2" Content="Clear" Command="{Binding ClearContainerTypeCommand}"
                                                Padding="2" Margin="2" FontSize="10"/>

                                        <TextBlock Grid.Row="1" Grid.Column="0" Text="Units/Container" VerticalAlignment="Center" Margin="0,2"/>
                                        <TextBox Grid.Row="1" Grid.Column="1"
                                                 Text="{Binding EditUnitsPerContainer, UpdateSourceTrigger=PropertyChanged}" Margin="0,2"/>
                                        <Button Grid.Row="1" Grid.Column="2" Content="Clear" Command="{Binding ClearUnitsPerContainerCommand}"
                                                Padding="2" Margin="2" FontSize="10"/>

                                        <CheckBox Grid.Row="2" Grid.Column="0" Grid.ColumnSpan="2"
                                                  Content="Requires Forklift"
                                                  IsChecked="{Binding EditRequiresForklift}" Margin="0,5"/>

                                        <TextBlock Grid.Row="3" Grid.Column="0" Text="Notes" VerticalAlignment="Top" Margin="0,2"/>
                                        <TextBox Grid.Row="3" Grid.Column="1"
                                                 Text="{Binding EditNotes, UpdateSourceTrigger=PropertyChanged}"
                                                 TextWrapping="Wrap" AcceptsReturn="True" Height="60" Margin="0,2"/>
                                        <Button Grid.Row="3" Grid.Column="2" Content="Clear" Command="{Binding ClearNotesCommand}"
                                                Padding="2" Margin="2" FontSize="10" VerticalAlignment="Top"/>
                                    </Grid>

                                    <Button Content="Save Properties"
                                            Command="{Binding SavePropertiesCommand}"
                                            HorizontalAlignment="Left"
                                            Padding="15,5" Margin="0,15,0,0"/>
                                </StackPanel>
                            </TabItem>

                            <!-- Bill of Materials Tab -->
                            <TabItem Header="BOM">
                                <Grid Margin="10">
                                    <Grid.RowDefinitions>
                                        <RowDefinition Height="Auto"/>
                                        <RowDefinition Height="*"/>
                                        <RowDefinition Height="Auto"/>
                                        <RowDefinition Height="Auto"/>
                                    </Grid.RowDefinitions>

                                    <!-- Header -->
                                    <TextBlock Grid.Row="0" Text="Bill of Materials Components"
                                               FontWeight="SemiBold" Margin="0,0,0,10"/>

                                    <!-- BOM Items List -->
                                    <DataGrid Grid.Row="1"
                                              ItemsSource="{Binding BomItems}"
                                              SelectedItem="{Binding SelectedBomItem}"
                                              AutoGenerateColumns="False"
                                              CanUserAddRows="False"
                                              CanUserDeleteRows="False"
                                              IsReadOnly="False"
                                              SelectionMode="Single"
                                              Margin="0,0,0,10">
                                        <DataGrid.Columns>
                                            <DataGridTextColumn Header="Part Number"
                                                                Binding="{Binding ComponentVariant.PartNumber}"
                                                                IsReadOnly="True" Width="120"/>
                                            <DataGridTextColumn Header="Name"
                                                                Binding="{Binding ComponentVariant.Name}"
                                                                IsReadOnly="True" Width="*"/>
                                            <DataGridTextColumn Header="Qty"
                                                                Binding="{Binding Quantity, UpdateSourceTrigger=PropertyChanged}"
                                                                Width="60"/>
                                            <DataGridComboBoxColumn Header="UOM"
                                                                    SelectedItemBinding="{Binding UnitOfMeasure, UpdateSourceTrigger=PropertyChanged}"
                                                                    Width="60">
                                                <DataGridComboBoxColumn.ElementStyle>
                                                    <Style TargetType="ComboBox">
                                                        <Setter Property="ItemsSource" Value="{Binding DataContext.UnitsOfMeasure, RelativeSource={RelativeSource AncestorType=DataGrid}}"/>
                                                    </Style>
                                                </DataGridComboBoxColumn.ElementStyle>
                                                <DataGridComboBoxColumn.EditingElementStyle>
                                                    <Style TargetType="ComboBox">
                                                        <Setter Property="ItemsSource" Value="{Binding DataContext.UnitsOfMeasure, RelativeSource={RelativeSource AncestorType=DataGrid}}"/>
                                                    </Style>
                                                </DataGridComboBoxColumn.EditingElementStyle>
                                            </DataGridComboBoxColumn>
                                        </DataGrid.Columns>
                                    </DataGrid>

                                    <!-- Add Component Section -->
                                    <Border Grid.Row="2" BorderBrush="#DDD" BorderThickness="1" Padding="10" Margin="0,0,0,10">
                                        <Grid>
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="*"/>
                                                <ColumnDefinition Width="60"/>
                                                <ColumnDefinition Width="60"/>
                                                <ColumnDefinition Width="Auto"/>
                                            </Grid.ColumnDefinitions>
                                            <Grid.RowDefinitions>
                                                <RowDefinition Height="Auto"/>
                                                <RowDefinition Height="Auto"/>
                                            </Grid.RowDefinitions>

                                            <TextBlock Grid.Row="0" Grid.Column="0" Text="Component" FontSize="10" Foreground="Gray"/>
                                            <TextBlock Grid.Row="0" Grid.Column="1" Text="Qty" FontSize="10" Foreground="Gray"/>
                                            <TextBlock Grid.Row="0" Grid.Column="2" Text="UOM" FontSize="10" Foreground="Gray"/>

                                            <ComboBox Grid.Row="1" Grid.Column="0"
                                                      ItemsSource="{Binding AvailableComponents}"
                                                      SelectedItem="{Binding SelectedComponentToAdd}"
                                                      DisplayMemberPath="PartNumber"
                                                      Margin="0,2,5,0"/>
                                            <TextBox Grid.Row="1" Grid.Column="1"
                                                     Text="{Binding NewComponentQuantity, UpdateSourceTrigger=PropertyChanged}"
                                                     Margin="0,2,5,0"/>
                                            <ComboBox Grid.Row="1" Grid.Column="2"
                                                      ItemsSource="{Binding UnitsOfMeasure}"
                                                      SelectedItem="{Binding NewComponentUom}"
                                                      Margin="0,2,5,0"/>
                                            <Button Grid.Row="1" Grid.Column="3"
                                                    Content="Add"
                                                    Command="{Binding AddBomComponentCommand}"
                                                    Padding="10,2" Margin="0,2,0,0"/>
                                        </Grid>
                                    </Border>

                                    <!-- Actions and Error Message -->
                                    <StackPanel Grid.Row="3">
                                        <StackPanel Orientation="Horizontal">
                                            <Button Content="Remove Selected"
                                                    Command="{Binding RemoveBomItemCommand}"
                                                    Padding="10,5" Margin="0,0,10,0"/>
                                            <Button Content="Save Changes"
                                                    Command="{Binding UpdateBomItemCommand}"
                                                    Padding="10,5"/>
                                        </StackPanel>
                                        <TextBlock Text="{Binding BomErrorMessage}"
                                                   Foreground="Red"
                                                   Visibility="{Binding BomErrorMessage, Converter={StaticResource NullToCollapsed}}"
                                                   Margin="0,5,0,0"/>
                                    </StackPanel>
                                </Grid>
                            </TabItem>
                        </TabControl>
                    </StackPanel>
                </StackPanel>
            </ScrollViewer>

            <!-- Empty state when nothing selected -->
            <TextBlock Text="Select a family or variant to view details"
                       HorizontalAlignment="Center"
                       VerticalAlignment="Center"
                       Foreground="Gray"
                       Visibility="{Binding SelectedFamily, Converter={StaticResource NullToVisibility}}"/>
        </Grid>

        <!-- Loading overlay -->
        <Grid Grid.ColumnSpan="5"
              Background="#80FFFFFF"
              Visibility="{Binding IsLoading, Converter={StaticResource BoolToVisibility}}">
            <TextBlock Text="Loading..."
                       HorizontalAlignment="Center"
                       VerticalAlignment="Center"
                       FontSize="16"/>
        </Grid>
    </Grid>
</UserControl>
