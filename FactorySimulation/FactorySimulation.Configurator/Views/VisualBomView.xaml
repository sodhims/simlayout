<UserControl x:Class="FactorySimulation.Configurator.Views.VisualBomView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:local="clr-namespace:FactorySimulation.Configurator.Views"
             xmlns:configurator="clr-namespace:FactorySimulation.Configurator"
             mc:Ignorable="d"
             d:DesignHeight="600" d:DesignWidth="900">

    <UserControl.Resources>
        <!-- Converters -->
        <configurator:BoolToVisibilityConverter x:Key="BoolToVisibility"/>
        <configurator:InverseBoolToVisibilityConverter x:Key="InverseBoolToVisibility"/>
    </UserControl.Resources>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- Toolbar -->
        <ToolBar Grid.Row="0">
            <TextBlock Text="Product:" VerticalAlignment="Center" Margin="5,0"/>
            <ComboBox x:Name="ProductComboBox"
                      Width="250"
                      ItemsSource="{Binding AvailableProducts}"
                      SelectedItem="{Binding SelectedProduct}"
                      DisplayMemberPath="DisplayName"
                      SelectionChanged="ProductComboBox_SelectionChanged"/>

            <Separator/>

            <Button Content="Refresh" Click="RefreshButton_Click" Padding="10,3" ToolTip="Reload BOM tree"/>
            <Button Content="Expand All" Click="ExpandAllButton_Click" Padding="10,3" ToolTip="Expand all nodes"/>
            <Button Content="Collapse All" Click="CollapseAllButton_Click" Padding="10,3" ToolTip="Collapse all nodes"/>

            <Separator/>

            <ToggleButton x:Name="ComponentsOnlyToggle"
                          Content="Components Only"
                          IsChecked="{Binding ShowComponentsOnly}"
                          Padding="10,3"
                          ToolTip="Show only components (flat list with aggregated quantities)"/>

            <Separator/>

            <Button Content="Delete Selected" Click="DeleteSelectedButton_Click" Padding="10,3"
                    ToolTip="Delete selected component from BOM" IsEnabled="{Binding HasSelectedItem}"/>
        </ToolBar>

        <!-- Main Content Area -->
        <Grid Grid.Row="1">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="Auto"/>
            </Grid.ColumnDefinitions>

            <!-- Tree View -->
            <Border Grid.Column="0" BorderBrush="#CCCCCC" BorderThickness="1" Margin="5">
                <Grid>
                <!-- BOM Tree (normal view) -->
                <TreeView x:Name="BomTreeView"
                          ItemsSource="{Binding BomTree}"
                          SelectedItemChanged="BomTreeView_SelectedItemChanged"
                          Background="#FAFAFA"
                          BorderThickness="0"
                          Padding="5"
                          Visibility="{Binding ShowComponentsOnly, Converter={StaticResource InverseBoolToVisibility}}">
                    <TreeView.ItemContainerStyle>
                        <Style TargetType="TreeViewItem">
                            <Setter Property="IsExpanded" Value="True"/>
                            <Setter Property="Padding" Value="2"/>
                        </Style>
                    </TreeView.ItemContainerStyle>
                    <TreeView.ItemTemplate>
                        <HierarchicalDataTemplate ItemsSource="{Binding Children}">
                            <Border CornerRadius="4" Padding="8,4" Margin="2"
                                    Background="{Binding NodeColor}">
                                <StackPanel Orientation="Horizontal">
                                    <TextBlock Text="{Binding PartNumber}"
                                               FontWeight="SemiBold"
                                               Foreground="White"
                                               VerticalAlignment="Center"/>
                                    <TextBlock Text=" - " Foreground="White" VerticalAlignment="Center"/>
                                    <TextBlock Text="{Binding PartName}"
                                               Foreground="White"
                                               VerticalAlignment="Center"
                                               MaxWidth="200"
                                               TextTrimming="CharacterEllipsis"/>
                                    <Border Background="#80FFFFFF" CornerRadius="3" Padding="4,1" Margin="10,0,0,0"
                                            Visibility="{Binding ShowQuantity, Converter={StaticResource BoolToVisibility}}">
                                        <TextBlock Text="{Binding QuantityDisplay}"
                                                   FontSize="11"
                                                   Foreground="#333"/>
                                    </Border>
                                    <TextBlock Text="{Binding CategoryTag}"
                                               FontSize="10"
                                               Foreground="#CCFFFFFF"
                                               VerticalAlignment="Center"
                                               Margin="8,0,0,0"/>
                                </StackPanel>
                            </Border>
                        </HierarchicalDataTemplate>
                    </TreeView.ItemTemplate>
                </TreeView>

                <!-- Components Only List View - Visual with sortable headers -->
                <ListView x:Name="ComponentsListView"
                          ItemsSource="{Binding ComponentsOnlyView}"
                          SelectedItem="{Binding SelectedComponentItem}"
                          Background="#FAFAFA"
                          BorderThickness="0"
                          Padding="5"
                          GridViewColumnHeader.Click="ComponentsListView_ColumnHeaderClick"
                          Visibility="{Binding ShowComponentsOnly, Converter={StaticResource BoolToVisibility}}">
                    <ListView.View>
                        <GridView>
                            <!-- Category indicator column -->
                            <GridViewColumn Width="40">
                                <GridViewColumn.CellTemplate>
                                    <DataTemplate>
                                        <Border Width="24" Height="24" CornerRadius="4"
                                                Background="{Binding CategoryColor}"
                                                ToolTip="{Binding CategoryName}">
                                            <TextBlock Text="{Binding CategoryIcon}"
                                                       FontSize="12"
                                                       FontWeight="Bold"
                                                       Foreground="White"
                                                       HorizontalAlignment="Center"
                                                       VerticalAlignment="Center"/>
                                        </Border>
                                    </DataTemplate>
                                </GridViewColumn.CellTemplate>
                            </GridViewColumn>

                            <!-- Part Number with visual styling -->
                            <GridViewColumn Width="140">
                                <GridViewColumn.Header>
                                    <GridViewColumnHeader Tag="PartNumber" Content="Part Number ↕"/>
                                </GridViewColumn.Header>
                                <GridViewColumn.CellTemplate>
                                    <DataTemplate>
                                        <TextBlock Text="{Binding PartNumber}"
                                                   FontWeight="SemiBold"
                                                   Foreground="#1976D2"/>
                                    </DataTemplate>
                                </GridViewColumn.CellTemplate>
                            </GridViewColumn>

                            <!-- Name -->
                            <GridViewColumn Width="220">
                                <GridViewColumn.Header>
                                    <GridViewColumnHeader Tag="PartName" Content="Name ↕"/>
                                </GridViewColumn.Header>
                                <GridViewColumn.CellTemplate>
                                    <DataTemplate>
                                        <TextBlock Text="{Binding PartName}"
                                                   TextTrimming="CharacterEllipsis"
                                                   ToolTip="{Binding PartName}"/>
                                    </DataTemplate>
                                </GridViewColumn.CellTemplate>
                            </GridViewColumn>

                            <!-- Total Quantity with visual bar -->
                            <GridViewColumn Width="130">
                                <GridViewColumn.Header>
                                    <GridViewColumnHeader Tag="TotalQuantity" Content="Total Qty ↕"/>
                                </GridViewColumn.Header>
                                <GridViewColumn.CellTemplate>
                                    <DataTemplate>
                                        <Grid>
                                            <Border Background="{Binding QuantityBarColor}"
                                                    Opacity="0.3"
                                                    CornerRadius="2"
                                                    HorizontalAlignment="Left"
                                                    Width="{Binding QuantityBarWidth}"
                                                    Height="18"/>
                                            <TextBlock Text="{Binding TotalQuantityDisplay}"
                                                       FontWeight="SemiBold"
                                                       Margin="4,0,0,0"
                                                       VerticalAlignment="Center"/>
                                        </Grid>
                                    </DataTemplate>
                                </GridViewColumn.CellTemplate>
                            </GridViewColumn>

                            <!-- Unit of Measure -->
                            <GridViewColumn Width="55">
                                <GridViewColumn.Header>
                                    <GridViewColumnHeader Tag="UnitOfMeasure" Content="UoM ↕"/>
                                </GridViewColumn.Header>
                                <GridViewColumn.CellTemplate>
                                    <DataTemplate>
                                        <Border Background="#E0E0E0" CornerRadius="3" Padding="4,1">
                                            <TextBlock Text="{Binding UnitOfMeasure}"
                                                       FontSize="10"
                                                       HorizontalAlignment="Center"/>
                                        </Border>
                                    </DataTemplate>
                                </GridViewColumn.CellTemplate>
                            </GridViewColumn>

                            <!-- Unit Cost -->
                            <GridViewColumn Width="90">
                                <GridViewColumn.Header>
                                    <GridViewColumnHeader Tag="UnitCost" Content="Unit Cost ↕"/>
                                </GridViewColumn.Header>
                                <GridViewColumn.CellTemplate>
                                    <DataTemplate>
                                        <TextBlock Text="{Binding UnitCostDisplay}"
                                                   Foreground="{Binding CostForeground}"
                                                   HorizontalAlignment="Right"/>
                                    </DataTemplate>
                                </GridViewColumn.CellTemplate>
                            </GridViewColumn>

                            <!-- Extended Cost with highlight -->
                            <GridViewColumn Width="110">
                                <GridViewColumn.Header>
                                    <GridViewColumnHeader Tag="ExtendedCost" Content="Extended ↕"/>
                                </GridViewColumn.Header>
                                <GridViewColumn.CellTemplate>
                                    <DataTemplate>
                                        <Border Background="{Binding ExtendedCostBackground}"
                                                CornerRadius="3"
                                                Padding="6,2">
                                            <TextBlock Text="{Binding ExtendedCostDisplay}"
                                                       FontWeight="SemiBold"
                                                       Foreground="{Binding ExtendedCostForeground}"
                                                       HorizontalAlignment="Right"/>
                                        </Border>
                                    </DataTemplate>
                                </GridViewColumn.CellTemplate>
                            </GridViewColumn>
                        </GridView>
                    </ListView.View>
                    <ListView.ItemContainerStyle>
                        <Style TargetType="ListViewItem">
                            <Setter Property="Padding" Value="4,6"/>
                            <Setter Property="BorderBrush" Value="#E0E0E0"/>
                            <Setter Property="BorderThickness" Value="0,0,0,1"/>
                            <Style.Triggers>
                                <Trigger Property="IsMouseOver" Value="True">
                                    <Setter Property="Background" Value="#E3F2FD"/>
                                </Trigger>
                                <Trigger Property="IsSelected" Value="True">
                                    <Setter Property="Background" Value="#BBDEFB"/>
                                </Trigger>
                            </Style.Triggers>
                        </Style>
                    </ListView.ItemContainerStyle>
                </ListView>

                <!-- Placeholder when no product selected -->
                <StackPanel HorizontalAlignment="Center"
                            VerticalAlignment="Center"
                            Visibility="{Binding HasNoProduct, Converter={StaticResource BoolToVisibility}}">
                    <TextBlock Text="Select a product to view its BOM structure"
                               FontSize="16"
                               Foreground="Gray"
                               HorizontalAlignment="Center"/>
                    <TextBlock Text="Choose a product from the dropdown above"
                               FontSize="12"
                               Foreground="LightGray"
                               HorizontalAlignment="Center"
                               Margin="0,10,0,0"/>
                </StackPanel>

                <!-- Loading indicator -->
                <StackPanel HorizontalAlignment="Center"
                            VerticalAlignment="Center"
                            Visibility="{Binding IsLoading, Converter={StaticResource BoolToVisibility}}">
                    <TextBlock Text="Loading BOM..."
                               FontSize="14"
                               Foreground="Gray"
                               HorizontalAlignment="Center"/>
                </StackPanel>
            </Grid>
        </Border>

            <!-- Details Panel (shown when item selected) -->
            <Border Grid.Column="1"
                    BorderBrush="#CCCCCC"
                    BorderThickness="1"
                    Margin="0,5,5,5"
                    Width="280"
                    Background="White"
                    Visibility="{Binding HasSelectedItem, Converter={StaticResource BoolToVisibility}}">
                <ScrollViewer VerticalScrollBarVisibility="Auto">
                    <StackPanel Margin="15">
                        <!-- Header with category color -->
                        <Border CornerRadius="6"
                                Padding="12,8"
                                Background="{Binding SelectedItem.NodeColor}"
                                Margin="0,0,0,15">
                            <StackPanel>
                                <TextBlock Text="{Binding SelectedItem.PartNumber}"
                                           FontSize="16"
                                           FontWeight="Bold"
                                           Foreground="White"/>
                                <TextBlock Text="{Binding SelectedItem.CategoryTag}"
                                           FontSize="11"
                                           Foreground="#CCFFFFFF"
                                           Margin="0,2,0,0"/>
                            </StackPanel>
                        </Border>

                        <!-- Part Name -->
                        <TextBlock Text="Name"
                                   FontSize="10"
                                   Foreground="Gray"
                                   FontWeight="SemiBold"/>
                        <TextBlock Text="{Binding SelectedItem.PartName}"
                                   FontSize="14"
                                   TextWrapping="Wrap"
                                   Margin="0,2,0,12"/>

                        <!-- Quantity (if not root) -->
                        <StackPanel Visibility="{Binding SelectedItem.ShowQuantity, Converter={StaticResource BoolToVisibility}}">
                            <TextBlock Text="Quantity in Parent"
                                       FontSize="10"
                                       Foreground="Gray"
                                       FontWeight="SemiBold"/>
                            <StackPanel Orientation="Horizontal" Margin="0,2,0,12">
                                <Border Background="#E3F2FD" CornerRadius="4" Padding="8,4">
                                    <TextBlock Text="{Binding SelectedItem.Quantity, StringFormat=N2}"
                                               FontSize="18"
                                               FontWeight="Bold"
                                               Foreground="#1976D2"/>
                                </Border>
                                <TextBlock Text="{Binding SelectedItem.UnitOfMeasure}"
                                           FontSize="12"
                                           Foreground="Gray"
                                           VerticalAlignment="Center"
                                           Margin="8,0,0,0"/>
                            </StackPanel>
                        </StackPanel>

                        <!-- Unit Cost -->
                        <TextBlock Text="Unit Cost"
                                   FontSize="10"
                                   Foreground="Gray"
                                   FontWeight="SemiBold"/>
                        <TextBlock FontSize="14" Margin="0,2,0,12">
                            <TextBlock.Style>
                                <Style TargetType="TextBlock">
                                    <Setter Property="Text" Value="{Binding SelectedItem.UnitCost, StringFormat=${0:N2}}"/>
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding SelectedItem.UnitCost}" Value="0">
                                            <Setter Property="Text" Value="Not specified"/>
                                            <Setter Property="Foreground" Value="Gray"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </TextBlock.Style>
                        </TextBlock>

                        <!-- Extended Cost (Qty × Unit) -->
                        <StackPanel Visibility="{Binding SelectedItem.ShowQuantity, Converter={StaticResource BoolToVisibility}}">
                            <TextBlock Text="Extended Cost (Qty × Unit)"
                                       FontSize="10"
                                       Foreground="Gray"
                                       FontWeight="SemiBold"/>
                            <Border Background="{Binding SelectedExtendedCostBackground}"
                                    CornerRadius="4"
                                    Padding="8,6"
                                    Margin="0,2,0,12"
                                    HorizontalAlignment="Left">
                                <TextBlock Text="{Binding SelectedExtendedCost, StringFormat=${0:N2}}"
                                           FontSize="16"
                                           FontWeight="Bold"
                                           Foreground="{Binding SelectedExtendedCostForeground}"/>
                            </Border>
                        </StackPanel>

                        <!-- Children Count -->
                        <TextBlock Text="Direct Children"
                                   FontSize="10"
                                   Foreground="Gray"
                                   FontWeight="SemiBold"/>
                        <StackPanel Orientation="Horizontal" Margin="0,2,0,12">
                            <Border Background="#F5F5F5" CornerRadius="4" Padding="8,4">
                                <TextBlock Text="{Binding SelectedItem.Children.Count}"
                                           FontSize="16"
                                           FontWeight="Bold"/>
                            </Border>
                            <TextBlock Text="items"
                                       FontSize="12"
                                       Foreground="Gray"
                                       VerticalAlignment="Center"
                                       Margin="8,0,0,0"/>
                        </StackPanel>

                        <!-- Category Badge -->
                        <TextBlock Text="Category"
                                   FontSize="10"
                                   Foreground="Gray"
                                   FontWeight="SemiBold"/>
                        <Border Background="{Binding SelectedItem.NodeColor}"
                                CornerRadius="4"
                                Padding="10,5"
                                Margin="0,2,0,12"
                                HorizontalAlignment="Left">
                            <TextBlock Text="{Binding SelectedItemType}"
                                       FontSize="12"
                                       Foreground="White"
                                       FontWeight="SemiBold"/>
                        </Border>

                        <!-- Part Type ID (for debugging/reference) -->
                        <TextBlock Text="Internal ID"
                                   FontSize="10"
                                   Foreground="Gray"
                                   FontWeight="SemiBold"/>
                        <TextBlock Text="{Binding SelectedItem.PartTypeId}"
                                   FontSize="11"
                                   Foreground="Gray"
                                   Margin="0,2,0,0"/>
                    </StackPanel>
                </ScrollViewer>
            </Border>
        </Grid>

        <!-- Status Panel -->
        <Border Grid.Row="2" BorderBrush="#CCCCCC" BorderThickness="1,0,1,1" Margin="5,0,5,5" Padding="10">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <!-- Selected Item Info -->
                <StackPanel Grid.Column="0" Orientation="Horizontal"
                            Visibility="{Binding HasSelectedItem, Converter={StaticResource BoolToVisibility}}">
                    <TextBlock Text="Selected: " FontWeight="Bold"/>
                    <TextBlock Text="{Binding SelectedItemInfo}" Margin="5,0,20,0"/>
                    <TextBlock Text="Type: " FontWeight="Bold"/>
                    <TextBlock Text="{Binding SelectedItemType}" Margin="5,0,20,0"/>
                    <TextBlock Text="Quantity: " FontWeight="Bold"/>
                    <TextBlock Text="{Binding SelectedItemQuantity}"/>
                </StackPanel>

                <StackPanel Grid.Column="0" Orientation="Horizontal"
                            Visibility="{Binding HasSelectedItem, Converter={StaticResource InverseBoolToVisibility}}">
                    <TextBlock Text="Click on a node to select it" Foreground="Gray"/>
                </StackPanel>

                <!-- Stats -->
                <StackPanel Grid.Column="1" Orientation="Horizontal">
                    <TextBlock Text="{Binding StatusMessage}" Foreground="Gray"/>
                </StackPanel>
            </Grid>
        </Border>
    </Grid>
</UserControl>
